
@{
    ViewBag.Title = "SyncAdmin";
}

<script src="~/bower_components/webcomponentsjs/webcomponents.js"></script>
<link rel="import" href="~/bower_components/polymer/polymer.html">
<link rel="import" href="~/bower_components/x-webmidi/extras/wm-webmidilink/wm-webmidilink.html">
<link rel="import" href="~/bower_components/x-webmidi/extras/wm-pckeyboard/wm-pckeyboard.html">

<h2>Web MIDI API Demo - Broad Sync</h2>

<wm-webmidilink id="wmlink"></wm-webmidilink>
<wm-pckeyboard id="pckeyboard"></wm-pckeyboard>

<div style="margin-top: 20px; font-size: 1.2em">
    MIDI Input: <select id="midi-input"><option>Select ...</option></select><span id="virtual-input"></span><br /><br />
    MIDI Output: <select id="midi-output"><option>Select ...</option></select><span id="virtual-output"></span><br /><br />
</div>

<input type="button" id="play" value="CEG" />
<input type="button" id="play2" value="BDG" />

<div id="msg" style="margin-top:30px; font-size: 1.2em"></div>
<div id="debug" style="margin-top:30px;"></div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            var midi = { "inputs": [], "outputs": [] };
            var midiInputIndex = 0;
            var midiOutputIndex = 0;

            // Reference the auto-generated proxy for the hub.
            var webMidi = $.connection.webMIDIHub;

            // returns a Promise object representing a request for access to MIDI devices on the user's system.
            // Promise<MIDIAccess> requestMIDIAccess (optional MIDIOptions options);
            navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess, onMIDIFailure);

            function onMIDISuccess(/*MIDIAccess*/ midiAccess) {

                // List MIDI Input devices
                var it = midiAccess.inputs.values();
                for (var input = it.next() ; !input.done; input = it.next()) {
                    midi.inputs.push(input.value);
                }
                // Add a virtual MIDI Input Device
                midi.inputs.push((document.querySelector("#pckeyboard")).getInput());

                // Show MIDI input devices
                var listInput = document.querySelector("#midi-input");
                for (var i = 0; i < midi.inputs.length; i++) {
                    listInput.appendChild(new Option(midi.inputs[i]["name"], i));

                    var input = midi.inputs[i];
                    $("#debug").append("[type:'" + input.type + "'] id:'" + input.id +
                        "' manufacturer:'" + input.manufacturer + "' name:'" + input.name +
                        "' version:'" + input.version + "'" + " Virtual:'" + input.virtual + "'" + "<br />");
                }

                // When the input device is changed
                listInput.addEventListener("change", function (event) {

                    if (parseInt(event.target.value) >= 0) {
                        // Clear last onmidimessage handler
                        midi.inputs[midiInputIndex].onmidimessage = null;

                        // Set new onmidimessage handler of MIDIInput interface
                        midiInputIndex = event.target.value;
                        midi.inputs[midiInputIndex].onmidimessage = sendMIDIMessage;

                        // When the vertual MIDI Input device is selected
                        if (midi.inputs[midiInputIndex].virtual == true) {
                            document.querySelector("#virtual-input").appendChild(document.querySelector("#pckeyboard").getElement());
                        } else {
                            document.querySelector("#virtual-input").innerHTML = ""
                        }
                    }

                });

                // List MIDI Output devices
                var it = midiAccess.outputs.values();
                for (var output = it.next() ; !output.done; output = it.next()) {
                    midi.outputs.push(output.value);
                }
                // Add a virtual MIDI Output device
                midi.outputs.push((document.querySelector("#wmlink")).getOutput());

                // Show MIDI output devices
                var listOutput = document.querySelector("#midi-output");
                for (var i = 0; i < midi.outputs.length; i++) {
                    listOutput.appendChild(new Option(midi.outputs[i]["name"], i));

                    var output = midi.outputs[i];
                    $("#debug").append("[type:'" + output.type + "'] id:'" + output.id +
                        "' manufacturer:'" + output.manufacturer + "' name:'" + output.name +
                        "' version:'" + output.version + "'" + " Virtual:'" + output.virtual + "'" + "<br />");
                }

                // When the MIDI output devices is changed
                listOutput.addEventListener("change", function (event) {

                    if (parseInt(event.target.value) >= 0) {
                        midiOutputIndex = event.target.value;

                        // When the vertual MIDI output device is selected
                        if (midi.outputs[midiOutputIndex].virtual == true) {
                            document.querySelector("#virtual-output").appendChild(document.querySelector("#wmlink").getElement());
                        } else {
                            document.querySelector("#virtual-output").innerHTML = ""
                        }
                    }

                });

                function sendMIDIMessage(/*MIDIMessageEvent*/ event) {

                    var status = (event.data[0] & 0xf0);
                    if (status == 0xb0 || status == 0x80 || status == 0x90) {
                        //$("#msg").empty();

                        //// Show MIDI message (Hex)
                        //for (var i = 0; i < event.data.length; i++) {
                        //    $("#msg").append("0x" + ("00" + event.data[i].toString(16)).substr(-2) + " ");
                        //}
                        //$("#msg").append("<br />");

                        //// Show MIDI message (Bin)
                        //for (var i = 0; i < event.data.length; i++) {
                        //    $("#msg").append(("0000000" + event.data[i].toString(2)).substr(-8) + " ");
                        //}
                        //$("#msg").append("<br />");

                        if (event.data.length == 3)
                            webMidi.server.webMIDIOutput(event.data[0], event.data[1], event.data[2]);
                    }
                }

                // Create a function that the hub can call back to display messages.
                webMidi.client.webMIDIInput = function (status, msg1, msg2) {
                    $("#msg").empty();
                    $("#msg").append("0x" + ("00" + status.toString(16)).substr(-2) + " ");
                    $("#msg").append("0x" + ("00" + msg1.toString(16)).substr(-2) + " ");
                    $("#msg").append("0x" + ("00" + msg2.toString(16)).substr(-2) + "<br />");
                    $("#msg").append(("0000000" + status.toString(2)).substr(-8) + " ");
                    $("#msg").append(("0000000" + msg1.toString(2)).substr(-8) + " ");
                    $("#msg").append(("0000000" + msg2.toString(2)).substr(-8) + "<br />");

                    // Send MIDI message
                    if (parseInt(midiOutputIndex) >= 0) {
                        midi.outputs[midiOutputIndex].send([status, msg1, msg2]);
                        controlChange(status, msg1, msg2);
                    }
                };

                var bkcolor = { "r": 255, "g": 255, "b": 255 };

                function controlChange(status, msg1, msg2) {

                    if ((status & 0xf0) == 0xb0) {
                        var cv = (msg2 * 2) + 1;

                        switch (msg1) {
                            case 20:
                                bkcolor.r = cv;
                                break;
                            case 21:
                                bkcolor.g = cv;
                                break;
                            case 22:
                                bkcolor.b = cv;
                                break;
                            default:
                                break;
                        }

                        //rgb(255, 0, 0);
                        $("body").css('background-color', 'rgb(' + bkcolor.r + ', ' + bkcolor.g + ', ' + bkcolor.b + ')');
                        $("#msg").append($("body").css('background-color') + "<br />");
                    }

                }

                $('#play').click(function () {
                    // Call the Send method on the hub.
                    webMidi.server.webMIDIOutput(0x90, 0x40, 0x7f); // E (ミ)
                    webMidi.server.webMIDIOutput(0x90, 0x43, 0x7f); // G (ソ)
                    webMidi.server.webMIDIOutput(0x90, 0x48, 0x7f); // C (ド)
                });

                $('#play2').click(function () {
                    // Call the Send method on the hub.
                    webMidi.server.webMIDIOutput(0x90, 0x3e, 0x7f); // D (レ)
                    webMidi.server.webMIDIOutput(0x90, 0x43, 0x7f); // G (ソ)
                    webMidi.server.webMIDIOutput(0x90, 0x47, 0x7f); // B (シ)
                });

                $.connection.hub.start().done();
            }

            function onMIDIFailure(msg) {
                alert("[ERROR] " + msg);
            }
        });
    </script>
}


